name: Refresh Recent Updates

on:
  schedule:
    - cron: "30 23 * * *" # daily at 23:30 UTC (Beijing 7:30 AM, considering GitHub queue delay)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: refresh-recent-updates
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          persist-credentials: true
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºè°ƒè¯•

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install --no-audit --progress=false

      - name: Refresh recent updates data
        run: node scripts/update-recent-updates.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          UPDATES_LIMIT: 7

      - name: Refresh project GitHub stars
        run: node scripts/update-project-stars.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Generate daily heartbeat
        if: github.event_name == 'schedule'
        run: |
          # åˆ›å»ºå¿ƒè·³æ–‡ä»¶ï¼Œç¡®ä¿æ¯å¤©éƒ½æœ‰æäº¤ï¼ˆä»…å®šæ—¶è§¦å‘æ—¶ï¼‰
          mkdir -p .github/heartbeat
          date -u +'Last sync: %Y-%m-%d %H:%M:%S UTC' > .github/heartbeat/.last-sync
          echo "âœ… Daily heartbeat generated"

      - name: Show working tree changes
        run: |
          echo "ğŸ“Š Git Status:"
          git status --porcelain
          echo ""
          echo "ğŸ“ Changed Files:"
          git diff --name-only || echo "No unstaged changes"
          echo ""
          echo "ğŸ“ˆ Diff Summary:"
          git diff --stat || echo "No differences"

      - name: Commit and push changes
        run: |
          # è®¾ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ·»åŠ æ‰€æœ‰å†…å®¹å˜æ›´ï¼ˆåŒ…æ‹¬å¿ƒè·³æ–‡ä»¶ï¼‰
          git add -A
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å·²æš‚å­˜çš„å˜æ›´
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit - all content is up to date"
            exit 0
          fi
          
          # å…ˆåŒæ­¥è¿œç«¯å†æäº¤/æ¨é€ï¼Œé™ä½å†²çªæ¦‚ç‡
          git pull --rebase --autostash origin "${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}" || true
          
          # æ™ºèƒ½ç”Ÿæˆæäº¤ä¿¡æ¯
          UPDATES_CHANGED=$(git diff --staged --name-only | grep -c "content/updates.json" || true)
          PROJECTS_CHANGED=$(git diff --staged --name-only | grep -c "content/projects.json" || true)
          HEARTBEAT_CHANGED=$(git diff --staged --name-only | grep -c ".github/heartbeat/.last-sync" || true)
          
          # æ ¹æ®å˜æ›´å†…å®¹ç”Ÿæˆæäº¤ä¿¡æ¯
          if [[ $UPDATES_CHANGED -gt 0 && $PROJECTS_CHANGED -gt 0 ]]; then
            COMMIT_MSG="chore: update latest activities and GitHub stars"
          elif [[ $UPDATES_CHANGED -gt 0 ]]; then
            COMMIT_MSG="chore: update latest activities"
          elif [[ $PROJECTS_CHANGED -gt 0 ]]; then
            COMMIT_MSG="chore: update GitHub project stars"
          elif [[ $HEARTBEAT_CHANGED -gt 0 ]]; then
            COMMIT_MSG="chore: daily sync"
          else
            COMMIT_MSG="chore: refresh content data"
          fi
          
          echo "ğŸ“¤ Committing: $COMMIT_MSG"
          git commit -m "$COMMIT_MSG"
          # è‹¥å¶å‘å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡
          git push || (git pull --rebase --autostash && git push)
          echo "âœ… Changes pushed successfully"
